---
title: "Model Building"
output: html_notebook
---
This is to organize our models. Pull the code cleaning the data from data_preprocessing.Rmd.
This file is separate because we have visualizations and other attempts to see how to clean the data the best in that file.
This file contains our best cleaning methods.

Load the data and clean it:
```{r}
rm(list=ls())
par(mfrow=c(1,1))

library(tidyverse)
library(leaps) # contanis regsubset()
library(fastDummies)
library(corrplot)
library(boot) # load library boot to use cv.glm

raw_data <- read.csv2("./LCdata.csv", header = TRUE, row.names=NULL, sep=";")

my_data <- raw_data

# drop columns per Gwen
my_data <- select(my_data, -c("collection_recovery_fee", "installment", "issue_d", "last_pymnt_amnt", "last_pymnt_d", "next_pymnt_d", "recoveries", "term", "total_pymnt_inv", "total_rec_int", "total_rec_late_fee", "total_rec_prncp", "id", "member_id")) 
# drop columns that are not useful
my_data <- subset(my_data, select = -emp_title)
my_data <- subset(my_data, select = -loan_status)
my_data <- subset(my_data, select = -pymnt_plan)
my_data <- subset(my_data, select = -url)
my_data <- subset(my_data, select = -desc)
my_data <- subset(my_data, select = -title)
my_data <- subset(my_data, select = -zip_code)
my_data <- subset(my_data, select = -addr_state)
my_data <- subset(my_data, select = -earliest_cr_line)
my_data <- subset(my_data, select = -out_prncp)
my_data <- subset(my_data, select = -out_prncp_inv)
my_data <- subset(my_data, select = -last_credit_pull_d)
my_data <- subset(my_data, select = -policy_code)
my_data <- subset(my_data, select = -funded_amnt)

# convert character to floats
my_data$int_rate <- as.double(my_data$int_rate)
my_data$dti <- as.double(my_data$dti)
my_data$dti_joint <- as.double(my_data$dti_joint)
my_data$il_util <- as.double(my_data$il_util)
my_data$all_util <- as.double(my_data$all_util)
my_data$revol_util <- as.double(my_data$revol_util)
my_data$total_pymnt <- as.double(my_data$total_pymnt) # drop?

# convert character to integer
my_data$annual_inc <- as.integer(my_data$annual_inc)
my_data$annual_inc_joint <- as.integer(my_data$annual_inc_joint)
my_data$funded_amnt_inv <- as.integer(my_data$funded_amnt_inv)

# convert character to ordered integers
# Note: should this be categorical?
my_data$emp_length <- as.integer(ordered(my_data$emp_length, levels = c("< 1 year", "1 year", "2 years", "3 years", "4 years", "5 years", "6 years", "7 years", "8 years", "9 years", "10+ years"))) - 1

# drop NA
my_data <- my_data %>%  # note this drops 40,000 records
  drop_na(emp_length)
my_data <- filter(my_data, ! is.na(my_data$home_ownership))
my_data <- filter(my_data, ! is.na(my_data$annual_inc))
my_data <- filter(my_data, ! is.na(my_data$delinq_2yrs))
my_data <- filter(my_data, ! is.na(my_data$revol_bal))
my_data <- filter(my_data, ! is.na(my_data$revol_util))
my_data <- filter(my_data, ! is.na(my_data$collections_12_mths_ex_med))

#dummy columns
my_data <- dummy_columns(my_data, select_columns = "home_ownership", remove_first_dummy = TRUE, remove_selected_columns = TRUE)
my_data <- dummy_columns(my_data, select_columns = "verification_status", remove_first_dummy = TRUE, remove_selected_columns = TRUE)
my_data <- dummy_columns(my_data, select_columns = "purpose", remove_first_dummy = TRUE, remove_selected_columns = TRUE)
my_data <- dummy_columns(my_data, select_columns = "application_type", remove_first_dummy = TRUE, remove_selected_columns = TRUE)
my_data <- dummy_columns(my_data, select_columns = "verification_status_joint", remove_first_dummy = TRUE, remove_selected_columns = TRUE)
my_data <- dummy_columns(my_data, select_columns = "initial_list_status", remove_first_dummy = TRUE, remove_selected_columns = TRUE)

# remove outliers
my_data$annual_inc <- ifelse(my_data$annual_inc >= 1000000, my_data$annual_inc / 100, my_data$annual_inc)

model_data <- my_data #make test modeling data
```



linear models

Stepwise forward selection



column 24 is causing problems, not sure why as it seems as though it should work.

```{r}
colSums(is.na(model_data))
```

Create list of the NA columns
These are not used for now, but further data processing may make them useful.
```{r}
force_out <- c("mths_since_last_delinq", "mths_since_last_record", "mths_since_last_major_derog", "annual_inc_joint", "dti_joint", "tot_coll_amt", "tot_cur_bal", "open_acc_6m", "open_il_6m", "open_il_12m", "open_il_24m", "mths_since_rcnt_il", "total_bal_il", "il_util", "open_rv_12m", "open_rv_24m", "max_bal_bc", "all_util", "total_rev_hi_lim", "inq_fi", "total_cu_tl", "inq_last_12m")
```

```{r}
model_data_no_na <- select(model_data, -force_out)
colSums(is.na(model_data_no_na))
```
```{r}
set.seed(1)
trainData <- sample(1:nrow(model_data_no_na), 0.7*nrow(model_data_no_na))
data.train <- model_data_no_na[trainData,]
data.test <- model_data_no_na[-trainData,]
```


1 linear dependency found. What parameters are co-linear?
```{r}
sets_FWS <- regsubsets(int_rate ~ ., data.train, nvmax = 40, method = "forward")
summary(sets_FWS)

```
Need to verify the different models are correct based on training data.
```{r}
initialize
glm1 <- glm(int_rate ~ revol_util, data = data.train)
glm2 <- glm(int_rate ~ revol_util + inq_last_6mths, data = data.train)
glm3 <- glm(int_rate ~ revol_util + inq_last_6mths + purpose_credit_card, data = data.train)
glm4 <- glm(int_rate ~ revol_util + inq_last_6mths + purpose_credit_card + verification_status_Verified, data = data.train)
glm5 <- glm(int_rate ~ revol_util + inq_last_6mths + purpose_credit_card + verification_status_Verified + annual_inc, data = data.train)
glm6 <- glm(int_rate ~ revol_util + inq_last_6mths + purpose_credit_card + verification_status_Verified + annual_inc + funded_amnt_inv, data = data.train)
glm7 <- glm(int_rate ~ revol_util + inq_last_6mths + purpose_credit_card + verification_status_Verified + annual_inc + funded_amnt_inv + purpose_debt_consolidation, data = data.train)
glm8 <- glm(int_rate ~ revol_util + inq_last_6mths + purpose_credit_card + verification_status_Verified + annual_inc + funded_amnt_inv + purpose_debt_consolidation + `verification_status_Source Verified`, data = data.train)
glm9 <- glm(int_rate ~ revol_util + inq_last_6mths + purpose_credit_card + verification_status_Verified + annual_inc + funded_amnt_inv + purpose_debt_consolidation + `verification_status_Source Verified` + home_ownership_MORTGAGE, data = data.train)
glm10 <- glm(int_rate ~ revol_util + inq_last_6mths + purpose_credit_card + verification_status_Verified + annual_inc + funded_amnt_inv + purpose_debt_consolidation + `verification_status_Source Verified` + home_ownership_MORTGAGE + initial_list_status_w, data = data.train) # to here is good
glm11 <- glm(int_rate ~ revol_util + inq_last_6mths + purpose_credit_card + verification_status_Verified + annual_inc + funded_amnt_inv + purpose_debt_consolidation + `verification_status_Source Verified` + home_ownership_MORTGAGE + initial_list_status_w + revol_bal, data = data.train)
glm12 <- glm(int_rate ~ revol_util + inq_last_6mths + purpose_credit_card + verification_status_Verified + annual_inc + funded_amnt_inv + purpose_debt_consolidation + `verification_status_Source Verified` + home_ownership_MORTGAGE + initial_list_status_w + revol_bal + dti, data = data.train)
glm13 <- glm(int_rate ~ revol_util + inq_last_6mths + purpose_credit_card + verification_status_Verified + annual_inc + funded_amnt_inv + purpose_debt_consolidation + `verification_status_Source Verified` + home_ownership_MORTGAGE + initial_list_status_w + revol_bal + dti + pub_rec, data = data.train)
glm14 <- glm(int_rate ~ revol_util + inq_last_6mths + purpose_credit_card + verification_status_Verified + annual_inc + funded_amnt_inv + purpose_debt_consolidation + `verification_status_Source Verified` + home_ownership_MORTGAGE + initial_list_status_w + revol_bal + dti + pub_rec + delinq_2yrs, data = data.train)
glm15 <- glm(int_rate ~ revol_util + inq_last_6mths + purpose_credit_card + verification_status_Verified + annual_inc + funded_amnt_inv + purpose_debt_consolidation + `verification_status_Source Verified` + home_ownership_MORTGAGE + initial_list_status_w + revol_bal + dti + pub_rec + delinq_2yrs + total_pymnt, data = data.train)
glm16 <- glm(int_rate ~ revol_util + inq_last_6mths + purpose_credit_card + verification_status_Verified + annual_inc + funded_amnt_inv + purpose_debt_consolidation + `verification_status_Source Verified` + home_ownership_MORTGAGE + initial_list_status_w + revol_bal + dti + pub_rec + delinq_2yrs + total_pymnt + purpose_home_improvement, data = data.train)
glm17 <- glm(int_rate ~ revol_util + inq_last_6mths + purpose_credit_card + verification_status_Verified + annual_inc + funded_amnt_inv + purpose_debt_consolidation + `verification_status_Source Verified` + home_ownership_MORTGAGE + initial_list_status_w + revol_bal + dti + pub_rec + delinq_2yrs + total_pymnt + purpose_home_improvement + purpose_major_purchase, data = data.train)
glm18 <- glm(int_rate ~ revol_util + inq_last_6mths + purpose_credit_card + verification_status_Verified + annual_inc + funded_amnt_inv + purpose_debt_consolidation + `verification_status_Source Verified` + home_ownership_MORTGAGE + initial_list_status_w + revol_bal + dti + pub_rec + delinq_2yrs + total_pymnt + purpose_home_improvement + purpose_major_purchase + total_acc, data = data.train)
glm19 <- glm(int_rate ~ revol_util + inq_last_6mths + purpose_credit_card + verification_status_Verified + annual_inc + funded_amnt_inv + purpose_debt_consolidation + `verification_status_Source Verified` + home_ownership_MORTGAGE + initial_list_status_w + revol_bal + dti + pub_rec + delinq_2yrs + total_pymnt + purpose_home_improvement + purpose_major_purchase + total_acc + open_acc, data = data.train)
glm20 <- glm(int_rate ~ revol_util + inq_last_6mths + purpose_credit_card + verification_status_Verified + annual_inc + funded_amnt_inv + purpose_debt_consolidation + `verification_status_Source Verified` + home_ownership_MORTGAGE + initial_list_status_w + revol_bal + dti + pub_rec + delinq_2yrs + total_pymnt + purpose_home_improvement + purpose_major_purchase + total_acc + open_acc + acc_now_delinq, data = data.train)
glm21 <- glm(int_rate ~ revol_util + inq_last_6mths + purpose_credit_card + verification_status_Verified + annual_inc + funded_amnt_inv + purpose_debt_consolidation + `verification_status_Source Verified` + home_ownership_MORTGAGE + initial_list_status_w + revol_bal + dti + pub_rec + delinq_2yrs + total_pymnt + purpose_home_improvement + purpose_major_purchase + total_acc + open_acc + acc_now_delinq + purpose_small_business, data = data.train)
glm22 <- glm(int_rate ~ revol_util + inq_last_6mths + purpose_credit_card + verification_status_Verified + annual_inc + funded_amnt_inv + purpose_debt_consolidation + `verification_status_Source Verified` + home_ownership_MORTGAGE + initial_list_status_w + revol_bal + dti + pub_rec + delinq_2yrs + total_pymnt + purpose_home_improvement + purpose_major_purchase + total_acc + open_acc + acc_now_delinq + purpose_small_business + purpose_other, data = data.train)
glm23 <- glm(int_rate ~ revol_util + inq_last_6mths + purpose_credit_card + verification_status_Verified + annual_inc + funded_amnt_inv + purpose_debt_consolidation + `verification_status_Source Verified` + home_ownership_MORTGAGE + initial_list_status_w + revol_bal + dti + pub_rec + delinq_2yrs + total_pymnt + purpose_home_improvement + purpose_major_purchase + total_acc + open_acc + acc_now_delinq + purpose_small_business + purpose_other + purpose_moving, data = data.train)
glm24 <- glm(int_rate ~ revol_util + inq_last_6mths + purpose_credit_card + verification_status_Verified + annual_inc + funded_amnt_inv + purpose_debt_consolidation + `verification_status_Source Verified` + home_ownership_MORTGAGE + initial_list_status_w + revol_bal + dti + pub_rec + delinq_2yrs + total_pymnt + purpose_home_improvement + purpose_major_purchase + total_acc + open_acc + acc_now_delinq + purpose_small_business + purpose_other + purpose_moving + purpose_house, data = data.train)
glm25 <- glm(int_rate ~ revol_util + inq_last_6mths + purpose_credit_card + verification_status_Verified + annual_inc + funded_amnt_inv + purpose_debt_consolidation + `verification_status_Source Verified` + home_ownership_MORTGAGE + initial_list_status_w + revol_bal + dti + pub_rec + delinq_2yrs + total_pymnt + purpose_home_improvement + purpose_major_purchase + total_acc + open_acc + acc_now_delinq + purpose_small_business + purpose_other + purpose_moving + purpose_house + purpose_medical, data = data.train)
```


We do a 10-fold cross-validation

```{r}
set.seed(1)
cv.err.glm1 <- cv.glm(data.train, glm1, K = 10) 
cv.err.glm2 <- cv.glm(data.train, glm2, K = 10) 
cv.err.glm3 <- cv.glm(data.train, glm3, K = 10) 
cv.err.glm4 <- cv.glm(data.train, glm4, K = 10) 
cv.err.glm5 <- cv.glm(data.train, glm5, K = 10)
cv.err.glm6 <- cv.glm(data.train, glm6, K = 10) 
cv.err.glm7 <- cv.glm(data.train, glm7, K = 10) 
cv.err.glm8 <- cv.glm(data.train, glm8, K = 10)
cv.err.glm9 <- cv.glm(data.train, glm9, K = 10)
cv.err.glm10 <- cv.glm(data.train, glm10, K = 10)
cv.err.glm11 <- cv.glm(data.train, glm11, K = 10)
cv.err.glm12 <- cv.glm(data.train, glm12, K = 10)
cv.err.glm13 <- cv.glm(data.train, glm13, K = 10)
cv.err.glm14 <- cv.glm(data.train, glm14, K = 10)
cv.err.glm15 <- cv.glm(data.train, glm15, K = 10)
cv.err.glm16 <- cv.glm(data.train, glm16, K = 10)
cv.err.glm17 <- cv.glm(data.train, glm17, K = 10)
cv.err.glm18 <- cv.glm(data.train, glm18, K = 10)
cv.err.glm19 <- cv.glm(data.train, glm19, K = 10)
cv.err.glm20 <- cv.glm(data.train, glm20, K = 10)
cv.err.glm21 <- cv.glm(data.train, glm21, K = 10)
cv.err.glm22 <- cv.glm(data.train, glm22, K = 10)
cv.err.glm23 <- cv.glm(data.train, glm23, K = 10)
cv.err.glm24 <- cv.glm(data.train, glm24, K = 10)
cv.err.glm25 <- cv.glm(data.train, glm25, K = 10)
```


We plot the CV error as a function of the number of predictors
```{r}
x <- 1:25 # define the x-axes (number of predictors)
(cv.err <- c(cv.err.glm1$delta[1], cv.err.glm2$delta[1], cv.err.glm3$delta[1], cv.err.glm4$delta[1],                      cv.err.glm5$delta[1],cv.err.glm6$delta[1],cv.err.glm7$delta[1], cv.err.glm8$delta[1], cv.err.glm9$delta[1], cv.err.glm10$delta[1], cv.err.glm11$delta[1], cv.err.glm12$delta[1], cv.err.glm13$delta[1], cv.err.glm14$delta[1], cv.err.glm15$delta[1], cv.err.glm16$delta[1], cv.err.glm17$delta[1], cv.err.glm18$delta[1], cv.err.glm19$delta[1], cv.err.glm20$delta[1], cv.err.glm21$delta[1], cv.err.glm22$delta[1], cv.err.glm23$delta[1], cv.err.glm24$delta[1], cv.err.glm25$delta[1]))
plot(cv.err ~x)
lines(cv.err ~x)
```
 [1] 17.86582 16.62822 15.86358 15.33236 14.99542 14.43929 14.23070 14.05053 13.93383 13.83293 13.71637 13.60494 13.53000 13.45494 13.39076 13.32795 13.28365
[18] 13.23878 13.19996 13.18435 13.17490 13.16831 13.15635 13.14714 13.13729



Here it's hard again to see which model wins. 
To see it more clearly, we find the minimum:

```{r}
(cv.min <- which.min(cv.err))
cv.err[cv.min]

```

Which model is it? Model 25. So we need more parameters to reduce underfitting / bias.

```{r}
coef(sets_FWS,25)
summary(glm25, correlation = TRUE)
```
*Highly correlated:*
Should we remove some of them?
purpose_credit_card <-> purpose_debt_consolidation
purpose_credit_card <-> purpose_home_improvement
purpose_credit_card <-> purpose_other
purpose_debt_consolidation <-> purpose_home_improvement
purpose_debt_consolidation <-> purpose_other

Some of the other purposes are semi-highly correlated (60-70). May be worth a look.


Note: This will take a long time to run. The idea is to run it for each parameter we choose.
```{r}
cv.error.10=rep(0,10)
for (i in 1:10){
    glm.fit = glm(int_rate ~ revol_util + poly(inq_last_6mths,7) + purpose_credit_card + verification_status_Verified + poly(annual_inc,10) + poly(funded_amnt_inv,10) + purpose_debt_consolidation + `verification_status_Source Verified` + home_ownership_MORTGAGE + poly(revol_bal,3) + dti + initial_list_status_w + poly(pub_rec,3) + poly(delinq_2yrs,2) + purpose_home_improvement + poly(total_pymnt,i) + purpose_major_purchase + total_acc + open_acc + acc_now_delinq + purpose_small_business + purpose_moving + purpose_other + purpose_house + purpose_medical, data = data.train)
    cv.error.10[i] = cv.glm(data.train,glm.fit,K=5)$delta[1] # Setting K=5 means 5-fold CV
}
cv.error.10
```

best poly, k = 10
revol_util: 1, but 2 is very close. After 3, goes quickly downhill
[1] 1.313748e+01 1.313807e+01 1.335145e+01 1.615801e+01 4.257502e+03 9.881411e+05 2.779848e+08 1.779192e+09 4.979685e+14 2.452146e+15

inq_last_6mths: 7, but may prefer 3 or 4 to keep it from overfitting. Or go with 1 becaus none of these are that different.
[1] 13.13672 13.08867 13.07047 13.06873 13.06840 13.06889 13.06828 13.07053 13.06983 13.08498

annual_inc: 10, but may prefer 3 or 4 to keep it from overfitting. Or go with 1 becaus none of these are that different.
[1] 13.06796 12.85943 12.78952 12.76273 12.76079 12.76030 12.76030 12.75972 12.75960 12.75934

from here, only a k = 5
funded_amnt_inv: 1, 2, 5, or 10. Or go with 1 becaus none of these are that different.
[1] 12.75973 12.72842 12.75470 12.70118 12.67908 13.77973 12.66829 12.65892 12.64501 12.64331

revol_bal: 3 or 1
 [1]     12.64375     12.62409     12.54643     12.54751     12.93488     27.34618    289.19445   8785.86063 533956.06421 224162.51917

dti: 1
 [1] 1.254469e+01 1.269465e+01 1.281557e+01 1.070648e+02 1.321001e+03 1.250976e+06 6.864439e+07 6.882024e+08 2.999944e+11 5.651942e+15

pub_rec: 3 Or go with 1 becaus none of these are that different on the left side.
 [1]   12.55580   12.53535   12.53258   12.54563   12.81418   12.53925   12.65237   27.34062 1119.21629  152.12983

delinq_2yrs: 4 is the lowest, but not really different from 2
 [1]   14.16914   12.50662   12.50743   12.49501   12.57875   12.61406   12.50057   18.79284   19.55115 1092.33130

total_pymnt: 8 is the minimum. But not really different from 1
 [1] 12.50376 12.50533 13.49381 12.47696 12.45606 12.45684 13.94445 12.45178 12.46844 12.47446

total_acc:

open_acc: 

acc_now_delinq:


See if a 5-fold gives us anything different
```{r}
set.seed(1)
cv.err.glm1.5 <- cv.glm(data.train, glm1, K = 5) 
cv.err.glm2.5 <- cv.glm(data.train, glm2, K = 5) 
cv.err.glm3.5 <- cv.glm(data.train, glm3, K = 5) 
cv.err.glm4.5 <- cv.glm(data.train, glm4, K = 5) 
cv.err.glm5.5 <- cv.glm(data.train, glm5, K = 5)
cv.err.glm6.5 <- cv.glm(data.train, glm6, K = 5) 
cv.err.glm7.5 <- cv.glm(data.train, glm7, K = 5) 
cv.err.glm8.5 <- cv.glm(data.train, glm8, K = 5)
cv.err.glm9.5 <- cv.glm(data.train, glm9, K = 5)
cv.err.glm10.5 <- cv.glm(data.train, glm10, K = 5)
cv.err.glm11.5 <- cv.glm(data.train, glm11, K = 5)
cv.err.glm12.5 <- cv.glm(data.train, glm12, K = 5)
cv.err.glm13.5 <- cv.glm(data.train, glm13, K = 5)
cv.err.glm14.5 <- cv.glm(data.train, glm14, K = 5)
cv.err.glm15.5 <- cv.glm(data.train, glm15, K = 5)
cv.err.glm16.5 <- cv.glm(data.train, glm16, K = 5)
cv.err.glm17.5 <- cv.glm(data.train, glm17, K = 5)
cv.err.glm18.5 <- cv.glm(data.train, glm18, K = 5)
cv.err.glm19.5 <- cv.glm(data.train, glm19, K = 5)
cv.err.glm20.5 <- cv.glm(data.train, glm20, K = 5)
cv.err.glm21.5 <- cv.glm(data.train, glm21, K = 5)
cv.err.glm22.5 <- cv.glm(data.train, glm22, K = 5)
cv.err.glm23.5 <- cv.glm(data.train, glm23, K = 5)
cv.err.glm24.5 <- cv.glm(data.train, glm24, K = 5)
cv.err.glm25.5 <- cv.glm(data.train, glm25, K = 5)
```



We plot the CV error as a function of the number of predictors
```{r}
x <- 1:25 # define the x-axes (number of predictors)
(cv.err.5 <- c(cv.err.glm1.5$delta[1], cv.err.glm2.5$delta[1], cv.err.glm3.5$delta[1], cv.err.glm4.5$delta[1],                      cv.err.glm5.5$delta[1],cv.err.glm6.5$delta[1],cv.err.glm7.5$delta[1], cv.err.glm8.5$delta[1], cv.err.glm9.5$delta[1], cv.err.glm10.5$delta[1], cv.err.glm11.5$delta[1], cv.err.glm12.5$delta[1], cv.err.glm13.5$delta[1], cv.err.glm14.5$delta[1], cv.err.glm15.5$delta[1], cv.err.glm16.5$delta[1], cv.err.glm17.5$delta[1], cv.err.glm18.5$delta[1], cv.err.glm19.5$delta[1], cv.err.glm20.5$delta[1], cv.err.glm21.5$delta[1], cv.err.glm22.5$delta[1], cv.err.glm23.5$delta[1], cv.err.glm24.5$delta.5[1], cv.err.glm25.5$delta[1]))


(cv.min.5 <- which.min(cv.err.5))
cv.err.5[cv.min.5]
```
It gives me model 24 as the best





Stepwise backward selection
```{r}
sets_BWS <- regsubsets(int_rate ~ ., data.train, nvmax = 40, method = "backward")
summary(sets_BWS)
```

```{r}
par(mfrow=c(2,3))
# FWS
plot(sets_FWS, scale="adjr2", title(main="Foreward Stepwise"))
plot(sets_FWS, scale="Cp", title(main="Foreward Stepwise"))
plot(sets_FWS, scale="bic", title(main="Foreward Stepwise"))
# BWS
plot(sets_FWS, scale="adjr2", title(main="Backward Stepwise"))
plot(sets_FWS, scale="Cp", title(main="Backward Stepwise"))
plot(sets_FWS, scale="bic", title(main="Backward Stepwise"))
par(mfrow=c(1,1))
```

